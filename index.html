<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>歯科医院 日計表 入力</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 20px;
        }
        .upload-section {
            text-align: center;
            margin: 30px 0;
            padding: 40px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            background-color: #fafafa;
        }
        .file-input {
            display: none;
        }
        .upload-button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .upload-button:hover {
            background-color: #45a049;
        }
        .upload-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status-message {
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .file-info {
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        .data-input-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        .form-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }
        .form-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .summary-section {
            grid-column: 1 / -1;
            background-color: #e8f5e8;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .date-input {
            text-align: center;
            margin: 20px 0;
        }
        .date-input input {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        @media (max-width: 768px) {
            .data-input-form {
                grid-template-columns: 1fr;
            }
        }
        .debug-info {
            margin: 15px 0;
            padding: 10px;
            background-color: #f1f3f4;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>歯科医院 日計表 入力</h1>
            <div class="date-input">
                <label for="date">日付:</label>
                <input type="date" id="date" value="">
                <span id="dateDisplay">(令和7年6月7日 土曜日)</span>
            </div>
        </div>

        <div class="upload-section">
            <h2>PDFからデータを自動抽出</h2>
            <p>PDFファイルをアップロードして、ワークフローで処理します。</p>
            
            <input type="file" id="fileInput" class="file-input" accept=".pdf" />
            <button onclick="document.getElementById('fileInput').click()" class="upload-button">
                ファイルを選択
            </button>
            
            <div id="fileInfo" class="file-info" style="display: none;"></div>
            <div id="statusMessage" class="status-message" style="display: none;"></div>
            <div id="debugInfo" class="debug-info" style="display: none;"></div>
        </div>

        <div class="data-input-form">
            <!-- 当日の売上登録 -->
            <div class="form-section">
                <h3>当日の売上登録</h3>
                
                <div class="form-group">
                    <label for="shaho_count">社保の人数</label>
                    <input type="number" id="shaho_count" value="0">
                </div>
                <div class="form-group">
                    <label for="shaho_amount">社保の金額</label>
                    <input type="number" id="shaho_amount" value="0">
                </div>
                
                <div class="form-group">
                    <label for="kokuho_count">国保の人数</label>
                    <input type="number" id="kokuho_count" value="0">
                </div>
                <div class="form-group">
                    <label for="kokuho_amount">国保の金額</label>
                    <input type="number" id="kokuho_amount" value="0">
                </div>
                
                <div class="form-group">
                    <label for="kouki_count">後期高齢者医療の人数</label>
                    <input type="number" id="kouki_count" value="0">
                </div>
                <div class="form-group">
                    <label for="kouki_amount">後期高齢者医療の金額</label>
                    <input type="number" id="kouki_amount" value="0">
                </div>
                
                <div class="form-group">
                    <label for="jihi_count">自費の人数</label>
                    <input type="number" id="jihi_count" value="0">
                </div>
                <div class="form-group">
                    <label for="jihi_amount">自費の金額</label>
                    <input type="number" id="jihi_amount" value="0">
                </div>
                
                <div class="form-group">
                    <label for="hoken_nashi_count">保険なしの人数</label>
                    <input type="number" id="hoken_nashi_count" value="0">
                </div>
                <div class="form-group">
                    <label for="hoken_nashi_amount">保険なしの金額</label>
                    <input type="number" id="hoken_nashi_amount" value="0">
                </div>
            </div>

            <!-- 売上調整記録 -->
            <div class="form-section">
                <h3>売上調整記録</h3>
                
                <div class="form-group">
                    <label for="previous_difference">前回差額</label>
                    <input type="number" id="previous_difference" value="0">
                </div>
                
                <div class="form-group">
                    <label for="kouki_amount">後期の金額</label>
                    <input type="number" id="kouki_amount_adj" value="0">
                </div>
                
                <div class="form-group">
                    <label for="bushan_note">物販</label>
                    <input type="text" id="bushan_note" value="">
                </div>
                
                <div class="form-group">
                    <label for="bushan_amount">物販の金額</label>
                    <input type="number" id="bushan_amount" value="0">
                </div>
            </div>

            <!-- 合計と確認 -->
            <div class="summary-section">
                <h3>売上確認</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                    <div>
                        <strong>前日の残高:</strong><br>
                        <span id="previous_balance">30000</span>円
                    </div>
                    <div>
                        <strong>本日の売上:</strong><br>
                        <span id="today_total">0</span>円
                    </div>
                    <div>
                        <strong>本日の残高:</strong><br>
                        <span id="current_balance">30000</span>円
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 現在の日付を設定
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        document.getElementById('date').value = `${year}-${month}-${day}`;

        // ファイル選択時の処理
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                showFileInfo(file);
                processFile(file);
            }
        });

        // ファイル情報の表示
        function showFileInfo(file) {
            const fileInfo = document.getElementById('fileInfo');
            
            // ファイルの基本情報
            let info = `ファイル名: ${file.name}\n`;
            info += `ファイルサイズ: ${(file.size / 1024).toFixed(2)} KB\n`;
            info += `ファイルタイプ: ${file.type}\n`;
            info += `最終更新: ${new Date(file.lastModified).toLocaleString()}\n`;
            
            fileInfo.textContent = info;
            fileInfo.style.display = 'block';
            
            // ファイル内容の詳細検証
            const reader = new FileReader();
            reader.onload = function(e) {
                const arrayBuffer = e.target.result;
                const uint8Array = new Uint8Array(arrayBuffer);
                
                // ファイルヘッダーの確認
                const header = Array.from(uint8Array.slice(0, 8))
                    .map(b => String.fromCharCode(b))
                    .join('');
                
                const headerHex = Array.from(uint8Array.slice(0, 8))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join(' ');
                
                const isPDF = header.startsWith('%PDF-');
                
                info += `\n--- 詳細検証 ---\n`;
                info += `ファイルヘッダー: ${header}\n`;
                info += `ヘッダー(HEX): ${headerHex}\n`;
                info += `PDF形式: ${isPDF ? '✓ 有効' : '✗ 無効'}\n`;
                
                if (!isPDF) {
                    info += `\n⚠️ 警告: このファイルは有効なPDFファイルではありません。\n`;
                    showStatus('warning', 'ファイル形式の警告: 有効なPDFファイルではない可能性があります。');
                }
                
                fileInfo.textContent = info;
            };
            reader.readAsArrayBuffer(file);
        }

        // ファイル処理
        async function processFile(file) {
            try {
                showStatus('info', 'ファイルを処理中...');
                showDebugInfo('ファイル処理を開始します...');
                
                // ファイルをBase64に変換
                const base64Data = await fileToBase64(file);
                showDebugInfo(`Base64変換完了: ${base64Data.length} 文字`);
                
                // APIに送信
                const response = await fetch('/api/dify-proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        pdf_data: base64Data,
                        file_name: file.name
                    })
                });

                showDebugInfo(`API レスポンス: ${response.status} ${response.statusText}`);
                
                const result = await response.json();
                console.log('API Response:', result);
                showDebugInfo(`API結果: ${JSON.stringify(result, null, 2)}`);

                if (result.data && result.data.outputs) {
                    const outputs = result.data.outputs;
                    
                    if (outputs.__is_success === 1) {
                        showStatus('success', 'データの抽出に成功しました！');
                        populateForm(outputs);
                        
                        // 成功時の詳細情報
                        if (outputs._file_validation) {
                            const validation = outputs._file_validation;
                            showDebugInfo(`ファイル検証結果:
                                PDF形式: ${validation.is_pdf}
                                ファイルヘッダー: ${validation.file_header}
                                バッファサイズ: ${validation.buffer_size} bytes`);
                        }
                    } else {
                        showStatus('error', `処理に失敗しました: ${outputs.__reason || '不明なエラー'}`);
                        
                        // エラー時のデバッグ情報
                        if (outputs._debug_info) {
                            showDebugInfo(`デバッグ情報: ${JSON.stringify(outputs._debug_info, null, 2)}`);
                        }
                    }
                } else {
                    showStatus('error', '予期しない応答形式です。');
                    showDebugInfo(`予期しない応答: ${JSON.stringify(result, null, 2)}`);
                }

            } catch (error) {
                console.error('Error processing file:', error);
                showStatus('error', `エラーが発生しました: ${error.message}`);
                showDebugInfo(`エラー詳細: ${error.stack}`);
            }
        }

        // ファイルをBase64に変換
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }

        // フォームにデータを入力
        function populateForm(data) {
            const fields = [
                'shaho_count', 'shaho_amount',
                'kokuho_count', 'kokuho_amount', 
                'kouki_count', 'kouki_amount',
                'jihi_count', 'jihi_amount',
                'hoken_nashi_count', 'hoken_nashi_amount',
                'previous_difference', 'bushan_amount'
            ];

            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element && data[field] !== undefined) {
                    // 数値から不要な文字を除去
                    const value = String(data[field]).replace(/[^\d.-]/g, '');
                    element.value = value || '0';
                }
            });

            // 物販メモ
            if (data.bushan_note) {
                const bushanNote = document.getElementById('bushan_note');
                if (bushanNote) {
                    bushanNote.value = data.bushan_note;
                }
            }

            // 合計を再計算
            calculateTotals();
        }

        // ステータスメッセージの表示
        function showStatus(type, message) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status-message ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        // デバッグ情報の表示
        function showDebugInfo(message) {
            const debugDiv = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.textContent += `[${timestamp}] ${message}\n`;
            debugDiv.style.display = 'block';
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        // 合計計算
        function calculateTotals() {
            const getValue = (id) => parseInt(document.getElementById(id)?.value || '0') || 0;
            
            const todayTotal = getValue('shaho_amount') + getValue('kokuho_amount') + 
                             getValue('kouki_amount') + getValue('jihi_amount') + 
                             getValue('hoken_nashi_amount') + getValue('bushan_amount');
            
            const previousBalance = getValue('previous_difference') + 30000; // 基準残高
            const currentBalance = previousBalance + todayTotal;
            
            document.getElementById('today_total').textContent = todayTotal.toLocaleString();
            document.getElementById('current_balance').textContent = currentBalance.toLocaleString();
            document.getElementById('previous_balance').textContent = previousBalance.toLocaleString();
        }

        // 入力フィールドの変更時に合計を再計算
        document.addEventListener('input', function(e) {
            if (e.target.type === 'number') {
                calculateTotals();
            }
        });

        // 初期計算
        calculateTotals();
    </script>
</body>
</html>
